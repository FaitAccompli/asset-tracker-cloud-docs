---
platform: nRF Connect SDK
device: Nordic Semiconductor nRF9160
language: c
---

# Table of Contents

- [Introduction](#Introduction)
- [Step 1: Prerequisites](#Prerequisites)
- [Step 2: Prepare your Device](#Prepareyourdevice)
- [Step 3: Build SDK and Run Samples](#Build)
- [Step 4: Integration with Azure IoT Explorer](#Explorer)
- [Additional Links](#AdditionalLinks)

<a name="Introduction"></a>

# Introduction

**About this document**

This document describes how to connect Nordic Semiconductor's nRF9160 running
Zephyr with the
[Azure IoT Hub sample](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/nrf9160/azure_iot_hub/README.html)
from the
[nRF Connect SDK](https://www.nordicsemi.com/Software-and-tools/Software/nRF-Connect-SDK).
This multi-step process includes:

- Configuring Azure IoT Hub
- Provision the certificates onto the device
- Building, flashing and running the sample on the device

**About the nRF Connect SDK Azure IoT Hub sample**

[The sample](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/nrf9160/azure_iot_hub/README.html)
supports the direct connection of an IoT device that is already registered to an
Azure IoT Hub instance. Alternatively, it supports the provisioning of the
device using
[Azure IoT Hub Device Provisioning Service (DPS)](https://docs.microsoft.com/en-us/azure/iot-dps/)
to an IoT hub. See the documentation on
[Azure IoT Hub library](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/include/net/azure_iot_hub.html#lib-azure-iot-hub)
for more information.

The sample periodically publishes telemetry messages (events) to the connected
Azure IoT Hub instance. By default, telemetry messages are sent every 20
seconds. The default interval can be configured by setting the device twin
property `desired.telemetryInterval`, which will be interpreted by the sample in
units of seconds. The format of a telemetry message is shown below:

`json { "temperature": 25.2, "timestamp": 151325 } `

where `temperature` is a value between `25.0` and `25.9`, and `timestamp` is the
uptime of the device in milliseconds.

The sample has implemented the handling of
[Azure IoT Hub direct method](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-direct-methods)
with the name `led`. If the device receives a direct method invocation with the
name led and payload `1` or `0`, LED 1 on the device is turned on or off,
depending on the payload. On Thingy:91, the LED turns red if the payload is `1`.

<a name="Prerequisites"></a>

# Step 1: Prerequisites

You should have the following items ready before beginning the process:

- [Prepare your development environment](https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md)
- [Setup your IoT hub](https://github.com/robertalorro/azure-iot-device-ecosystem/blob/master/setup_iothub.md)
- [Provision your device over DPS](https://docs.microsoft.com/en-us/azure/iot-dps/about-iot-dps)
- acquire a nRF9160 Development Kit, for example the
  [Thingy:91](https://www.nordicsemi.com/Software-and-tools/Prototyping-platforms/Nordic-Thingy-91)
  or the
  [nRF9160 DK](https://www.nordicsemi.com/Software-and-tools/Development-Kits/nRF9160-DK)

<a name="Prepareyourdevice"></a>

# Step 2: Prepare your Device

The Azure IoT Hub library requires the provisioning of the following
certificates and a private key for a successful TLS connection:

1. [Baltimore CyberTrust Root certificate](https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt.pem) -
   Server certificate, used to verify the server’s certificate while connecting.
1. Device certificate - generated by the procedures described in
   [Creating Azure IoT Hub certificates](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started,)
   used by Azure IoT Hub to authenticate the device.
1. Private key of the device.

## Provisioning of the certificates

To provision the certificates and the private key to the nRF9160 modem, complete
the following steps:

1. Download
   [nRF Connect for Desktop](https://www.nordicsemi.com/Software-and-Tools/Development-Tools/nRF-Connect-for-desktop/Download#infotabs.)
1. Update the modem firmware on the onboard modem of the nRF9160-based device to
   the latest version by following the steps in
   [Updating the nRF9160 DK cellular modem](https://infocenter.nordicsemi.com/topic/ug_nc_programmer/UG/nrf_connect_programmer/ncp_updating_modem_nrf9160dk.html.)
1. Build and program the
   [nRF9160: AT Client](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/nrf9160/at_client/README.html#at-client-sample)
   sample to the nRF9160-based device as explained in
   [Building and programming a sample application](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/gs_programming.html#gs-programming.)
1. Launch the
   [LTE Link Monitor application](https://infocenter.nordicsemi.com/topic/ug_link_monitor/UG/link_monitor/lm_intro.html,)
   which is part of
   [nRF Connect for Desktop](https://www.nordicsemi.com/Software-and-Tools/Development-Tools/nRF-Connect-for-desktop/Download#infotabs.)
1. Click _Certificate manager_ located at the top right corner.
1. Copy the
   [Baltimore CyberTrust Root certificate](https://www.digicert.com/CACerts/BaltimoreCyberTrustRoot.crt.pem)
   into the `CA certificate` entry.
1. Copy and paste the device certificate and the key created using the scripts
   located in
   [Creating Azure IoT Hub certificates](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-security-x509-get-started,)
   into the respective entries (`Client certificate`, `Private key`).
1. Select a desired security tag (any positive integer, for example, `42`) and
   click _Update certificates_.

<a name="Build"></a>

# Step 3: Build SDK and Run Samples

This sample can be found under
[`samples/nrf9160/azure_iot_hub`](https://github.com/nrfconnect/sdk-nrf/tree/master/samples/nrf9160/azure_iot_hub)
in the nRF Connect SDK folder structure.

## Step 3.1: Configure the sample

Check and configure the following library options that are used by the sample:

- `CONFIG_AZURE_IOT_HUB_DEVICE_ID` - Sets the Azure IoT Hub device ID.
  Alternatively, enable `CONFIG_AZURE_IOT_HUB_DEVICE_ID_APP` option and set the
  device ID at run time in `azure_iot_hub_config` passed to the
  `azure_iot_hub_init()` function.
- `CONFIG_AZURE_IOT_HUB_HOSTNAME` - Sets the Azure IoT Hub host name. If DPS is
  used, the sample assumes that the IoT hub host name is unknown, and the
  configuration is ignored.
- `CONFIG_AZURE_IOT_HUB_DPS` - Enables Azure IoT Hub DPS.
- `CONFIG_AZURE_IOT_HUB_DPS_ID_SCOPE` - Sets the Azure IoT Hub DPS ID scope.

## Step 3.2: Build the sample

The sample is built as a non-secure firmware image for the `nrf9160dk_nrf9160ns`
build target. Because of this, it automatically includes the
[Secure Partition Manager](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/spm/README.html#secure-partition-manager.)

See
[Building and programming a sample application](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/gs_programming.html#gs-programming)
for information about how to build and program the application.

The sample is configured to compile and run as a non-secure application on
nRF91’s Cortex-M33. Therefore, it automatically includes the
[Secure Partition Manager](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/samples/spm/README.html#secure-partition-manager)
that prepares the required peripherals to be available for the application.

## Step 3.3: Run the sample

After programming the sample to your development kit, test it by performing the
following steps:

1. Connect the kit to the computer using a USB cable. The kit is assigned a COM
   port (Windows) or ttyACM device (Linux), which is visible in the Device
   Manager.
1. Connect to the kit with a terminal emulator (for example, PuTTY). See
   [How to connect with PuTTY](connect-with-putty) for the required settings.
1. Reset the development kit.
1. Observe the log output and verify that it is similar to the
   [Sample Output](#sampoutput).
1. Select the connected IoT hub and then your device.
1. Change the device twin’s `desired` property `telemetryInterval` to a new
   value, for instance `10`, and save the updated device twin. If it does not
   exist, you can add the `desired` property.
1. Observe that the device receives the updated `telemetryInterval` value,
   applies it, and starts sending new telemetry events every 10 seconds.
1. Verify that the `reported` object in the device twin now has a
   `telemetryInterval` property with the correct value reported back from the
   device.
1. On the device page, navigate to the Direct method tab.
1. Enter `led` as the method name. In the `payload` field, enter the value `1`
   (or `0`) and click Invoke method.
1. Observe that LED 1 on the development kit lights up (or switches off if `0`
   is entered as the payload).

<a name="SampleOutput"></a>

### Sample Output

When the sample runs, the device boots, and the sample displays an output
identical to the following output in the terminal over UART:

```
*** Booting Zephyr OS build v2.3.0-rc1-ncs1-1453-gf41496cd30d5 ***
Azure IoT Hub sample started
Connecting to LTE network
Connected to LTE network
AZURE_IOT_HUB_EVT_CONNECTING
AZURE_IOT_HUB_EVT_CONNECTED
AZURE_IOT_HUB_EVT_READY
AZURE_IOT_HUB_EVT_TWIN_RECEIVED
No 'telemetryInterval' object in the device twin
Sending event:
{"temperature":25.9,"timestamp":16849}
Event was successfully sent
Next event will be sent in 20 seconds

...

AZURE_IOT_HUB_EVT_TWIN`desired`RECEIVED
New telemetry interval has been applied: 60
AZURE_IOT_HUB_EVT_TWIN_RESULT_SUCCESS, ID: 42740
Sending event:
{"temperature":25.5,"timestamp":47585}
Event was successfully sent
Next event will be sent in 60 seconds
```

<a name="Explorer"></a>

# Step 4: Integration with Azure IoT Explorer

Microsoft has created
[Azure IoT Explorer](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer)
to interact and test devices connected to an Azure IoT Hub instance. Optionally,
follow the instructions at
[Azure IoT Explorer](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer)
to install and configure the tool and use it as mentioned in the below
instructions.

After programming the sample to your development kit, test it by performing the
following steps:

1. Connect the kit to the computer using a USB cable. The kit is assigned a COM
   port (Windows) or ttyACM device (Linux), which is visible in the Device
   Manager.
1. Connect to the kit with a terminal emulator (for example, PuTTY). See
   [How to connect with PuTTY](https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/gs_testing.html#putty)
   for the required settings.
1. Reset the development kit.
1. Observe the log output and verify that it is similar to the
   [sample output](#SampleOutput).
1. Use the
   [Azure IoT Explorer](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer),
   or log in to the [Azure Portal](https://portal.azure.com/).
1. Select the connected IoT hub and then your device.
1. Change the device twin's _desired_ property `telemetryInterval` to a new
   value, for instance `10`, and save the updated device twin. If it does not
   exist, you can add the _desired_ property.
1. Observe that the device receives the updated `telemetryInterval` value,
   applies it, and starts sending new telemetry events every 10 seconds.
1. Verify that the `reported` object in the device twin now has a
   `telemetryInterval` property with the correct value reported back from the
   device.
1. In the
   [Azure IoT Explorer](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer)
   or device page in [Azure Portal](https://portal.azure.com/), navigate to the
   `Direct method` tab.
1. Enter `led` as the method name. In the _payload_ field, enter the value `1`
   (or `0`) and click _Invoke method_.
1. Observe that LED 1 on the development kit lights up (or switches off if `0`
   is entered as the payload). If you are using
   [Azure IoT Explorer](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer),
   you can observe a notification in the top right corner stating if the direct
   method was successfully invoked based on the report received from the device.
1. If you are using the
   [Azure IoT Explorer](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer),
   navigate to the _Telemetry_ tab and click _start_.
1. Observe that the event messages from the device are displayed in the terminal
   within the specified telemetry interval.

<a name="AdditionalLinks"></a>

# Additional Links

Please refer to the below link for additional information

- [Manage cloud device messaging with Azure-IoT-Explorer](https://github.com/Azure/azure-iot-explorer/releases)
- [Azure SDK](https://github.com/Azure/azure-iot-sdk-c/blob/master/provisioning_client/samples/prov_dev_client_sample/prov_dev_client_sample.c)
- [Configure to connect to IoT Hub](https://docs.microsoft.com/en-us/azure/iot-pnp/quickstart-connect-device-c)
- [How to use IoT Explorer to interact with the device](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-use-iot-explorer#install-azure-iot-explorer)
